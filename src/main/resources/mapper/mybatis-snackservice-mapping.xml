<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="SnackMapper">

	<!-- 사용자 랭크 조회 sql 템플릿 -->
	<sql id="view-Memberrank">
		SELECT RANK() OVER (ORDER BY count DESC) 순위, member_id, count
		FROM (SELECT
		member_id, sum(count) AS count
		FROM history
		GROUP BY member_id)	
	</sql>
	
	<!-- 전체 재고 조회 sql 템플릿 -->	
	<sql id="select-snack">
		SELECT
		name, category, quantity, price, img_url
		FROM snack
	</sql>
	
	<!-- 회원 관리 기능 모음집 -->
	<!-- 회원 가입 -->
	<insert id="registerMember" parameterType="member">
		INSERT
		INTO member(member_id, name, password, vote_flag, role)
		VALUES(#{memberId}, #{name}, #{password}, #{voteFlag}, #{role})
	</insert>
	
	<!-- 회원 탈퇴 -->
	<delete id="deleteMember" parameterType="string">
		DELETE FROM member WHERE member_id=#{VALUE}
	</delete>
	
	<!-- 로그인 -->
	<select id = "login" parameterType="member" resultType = "member">
	SELECT
	member_id, name, password, vote_flag, role
	FROM member
	WHERE member_id=#{memberId} AND password=#{password}
	</select>
	
	<!-- 회원정보 수정-->
	<update id="updateMember" parameterType="member">
	UPDATE member SET
	password = #{password}
	WHERE member_id = #{memberId}
	</update>
	
	<!-- 마이페이지 기록 조회 -->
	<select id = "getHistory" parameterType = "member" resultType = "historyWithSnackName">
	SELECT
	s.name AS snackName, h.time, h.count 
	FROM history h JOIN snack s ON(h.snack_id = s.snack_id)
	WHERE member_id = #{memberId}
	</select>
	
	<!-- 간식 관리 기능 모음집 -->
	<!-- 전체 재고 조회 기능 -->
	<select id = "selectAll" resultType="snack">
		<include refid="select-snack"/>
	</select>
	
	<!-- 전체 투표 결과 조회 기능 -->
	<select id = "viewVote" resultType="vote">
		SELECT 
		snack_id, COUNT(member_id) AS count
		FROM vote
		GROUP BY snack_id
	</select>
	
	<!-- 전체 사용자 랭킹 조회 기능 -->
	<select id = "viewAllMemberrank">
		<include refid="view-Memberrank"/>
	</select>
	
	<!-- 전체 과자 랭킹 조회 기능 -->
	<select id = "viewAllSnackrank">
		 SELECT RANK() OVER (ORDER BY count DESC) 순위, s.name, t.count
	     FROM (SELECT
		 snack_id, sum(count) AS count
	     FROM history
	     GROUP BY snack_id) t JOIN snack s ON (t.snack_id=s.snack_id)
	</select>
	
	<!-- 과자별 사용자 랭킹 조회 기능 -->
	<select id = "viewSnackByMember">
		 SELECT RANK() OVER (ORDER BY count DESC) 순위, member_id, count
		FROM (SELECT
		member_id, sum(count) AS count
		FROM history
		WHERE snack_id=#{snack_id}
		GROUP BY member_id)	
	</select>
	
	<!-- 간식 선택 (재고 수량 변경) -->
	<!-- Controller에서 마이너스 해주기 -->
	 <update id = "fetchSnack" parameterType="snack">
        UPDATE snack
        SET quantity = #{quantity}
        WHERE snack_id = #{snackId}
    </update>
    
	<!-- 간식 선택 (history 테이블 추가) -->
    <insert id = "registerHistory" parameterType="snack">
        INSERT
        INTO history(member_id, snack_id, time, count)
        VALUES (#{memberId}, #{snackId}, sysdate, #{count})
    </insert>
    
    <!-- 간식 등록 -->
    <insert id="registerSnack" parameterType="snack">
    	INSERT
    	INTO snack(name, price, brand, category, quantity, img_url, link)
    	VALUES (#{name}, #{price}, #{brand}, #{category}, #{quantity}, #{imgUrl}, #{link})
    </insert>
    
    <!-- 간식 투표 -->
    <insert id="voteSnack" parameterType="vote">
    	INSERT
    	INTO vote(member_id, snack_id)
    	VALUES (#{memberId}, #{snackId})
    </insert>
    
    <!-- 간식 주문 -->
	<!-- Controller에서 플러스 해주기 -->
    <update id = "orderSnack" parameterType="snack">
        UPDATE snack
        SET quantity = #{quantity}
        WHERE snack_id = #{snackId}
    </update>
</mapper>
















